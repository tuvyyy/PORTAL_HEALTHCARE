<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <script>
    // ‚úÖ Th√™m thu·ªëc m·ªõi
    function addRow(drugName = '', dosage = '', frequency = '', days = 1, note = '') {
      const tbody = document.querySelector('#medicineBody');

      // X√≥a d√≤ng "Ch∆∞a c√≥ thu·ªëc n√†o" n·∫øu c√≥
      const emptyRow = tbody.querySelector('.empty-row');
      if (emptyRow) emptyRow.remove();

      const index = tbody.querySelectorAll('tr').length; // ƒê√°nh s·ªë th·ª© t·ª± cho m·∫£ng
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input name="items[${index}][drugName]" class="form-control" value="${drugName}" placeholder="T√™n thu·ªëc" required></td>
        <td><input name="items[${index}][dosage]" class="form-control" value="${dosage}" placeholder="Li·ªÅu l∆∞·ª£ng"></td>
        <td><input name="items[${index}][frequency]" class="form-control" value="${frequency}" placeholder="T·∫ßn su·∫•t"></td>
        <td><input name="items[${index}][days]" type="number" class="form-control" value="${days}" min="1"></td>
        <td><input name="items[${index}][note]" class="form-control" value="${note}" placeholder="Ghi ch√∫"></td>
        <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
      `;
      tbody.appendChild(tr);
    }

    // ‚úÖ X√≥a d√≤ng v√† c·∫≠p nh·∫≠t l·∫°i index
    function removeRow(btn) {
      const tr = btn.closest('tr');
      tr.remove();
      updateIndexes();
    }

    // ‚úÖ C·∫≠p nh·∫≠t l·∫°i index khi x√≥a d√≤ng
    function updateIndexes() {
      const rows = document.querySelectorAll('#medicineBody tr');
      rows.forEach((row, i) => {
        row.querySelectorAll('input').forEach(input => {
          const name = input.name.replace(/items\[\d+\]/, `items[${i}]`);
          input.name = name;
        });
      });

      if (rows.length === 0) {
        const tbody = document.querySelector('#medicineBody');
        const empty = document.createElement('tr');
        empty.classList.add('empty-row');
        empty.innerHTML = `<td colspan="6" class="text-center text-muted">Ch∆∞a c√≥ thu·ªëc n√†o trong toa</td>`;
        tbody.appendChild(empty);
      }
    }

    // ‚úÖ Kh·ªüi t·∫°o d·ªØ li·ªáu toa c≈©
    document.addEventListener('DOMContentLoaded', () => {
      <% if (items && items.length > 0) { %>
        <% items.forEach(it => { %>
          addRow(`<%= it.DrugName %>`, `<%= it.Dosage %>`, `<%= it.Frequency %>`, `<%= it.Days %>`, `<%= it.Note %>`);
        <% }) %>
      <% } %>
    });
  </script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-sm p-4">
      <h3 class="text-center text-success mb-4">
        üíä K√™ toa thu·ªëc <%= prescriptionId ? '(ƒë√£ c√≥ toa c≈©)' : '' %>
      </h3>

      <form method="POST" action="/doctor/prescriptions">
        <input type="hidden" name="recordId" value="<%= recordId %>">
        <input type="hidden" name="date" value="<%= date || '' %>">
        <input type="hidden" name="prescriptionId" value="<%= prescriptionId || '' %>">

        <table class="table table-bordered bg-white">
          <thead class="table-success">
            <tr>
              <th>T√™n thu·ªëc</th>
              <th>Li·ªÅu l∆∞·ª£ng</th>
              <th>T·∫ßn su·∫•t</th>
              <th>S·ªë ng√†y</th>
              <th>Ghi ch√∫</th>
              <th></th>
            </tr>
          </thead>
          <tbody id="medicineBody">
            <% if (!items || items.length === 0) { %>
              <tr class="empty-row">
                <td colspan="6" class="text-center text-muted">Ch∆∞a c√≥ thu·ªëc n√†o trong toa</td>
              </tr>
            <% } %>
          </tbody>
        </table>

        <div class="text-end mb-3">
          <button type="button" class="btn btn-outline-success" onclick="addRow()">‚ûï Th√™m thu·ªëc</button>
        </div>

        <button class="btn btn-success w-100">üíæ L∆∞u toa thu·ªëc</button>
      </form>
    </div>
  </div>
</body>
</html>
